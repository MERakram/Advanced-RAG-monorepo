services:
  # ---------------------------------------------------------------------------
  # 1. Vector Database: Qdrant
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: always
    networks:
      - rag-network

  # ---------------------------------------------------------------------------
  # 3. Frontend: Open Web UI
  # ---------------------------------------------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: rag-open-webui
    ports:
      - "3000:8080"
    environment:
      - OPENAI_API_BASE_URL=http://rag-app:8000/v1
      - OPENAI_API_KEY=local-vllm-key
      - WEBUI_SECRET_KEY=your_secret_key_here
      - ENABLE_OPENWEBUI_USER_HEADERS=true
      # Enable chat title generation
      - ENABLE_TITLE_GENERATION=true
      - 'TITLE_GENERATION_PROMPT_TEMPLATE=Create a concise, 3-5 word phrase as a title for the following chat query. RESPOND ONLY WITH THE TITLE TEXT: {{prompt}}'
    volumes:
      - open_webui_data:/app/backend/data
    depends_on:
      rag-app:
        condition: service_healthy
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - rag-network

  # ---------------------------------------------------------------------------
  # 5. Main Application (The RAG Pipeline)
  # ---------------------------------------------------------------------------
  rag-app:
    build: .
    container_name: rag-backend
    ports:
      - "5002:8000"
    environment:
      - QDRANT_URL=http://qdrant:6333
      - VLLM_URL=http://vllm:8000/v1
      - LANGFUSE_HOST=http://langfuse:3000
      - LANGFUSE_BASE_URL=http://langfuse:3000
      - LANGFUSE_PUBLIC_KEY=pk-lf-rag-default-public-key
      - LANGFUSE_SECRET_KEY=sk-lf-rag-default-secret-key
      - LANGFUSE_DEBUG=${LANGFUSE_DEBUG:-false}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - LOCAL_MODEL_NAME=${LOCAL_MODEL_NAME:-Qwen/Qwen2.5-0.5B-Instruct}
      - PYTHONPATH=.
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
      - easyocr_models:/root/.EasyOCR
      - docling_models:/root/.cache/docling
      - huggingface_models:/root/.cache/huggingface
    depends_on:
      - qdrant
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 60s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000
    networks:
      - rag-network

networks:
  rag-network:
    name: rag-network

volumes:
  qdrant_data:
  open_webui_data:
  easyocr_models:
  docling_models:
  huggingface_models:
    name: huggingface_models
